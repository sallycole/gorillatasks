
{% extends "base.html" %}

{% block head %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
.progress-none {
    color: #dc3545;  /* red */
}
.progress-partial {
    color: #ffc107;  /* yellow */
}
.progress-complete {
    color: #28a745;  /* green */
}
</style>
{% endblock %}

{% block content %}
<script>
// When page loads, check for stored task content
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're returning from a redirect with stored content
    const storedContent = sessionStorage.getItem('todo_tasks_content');
    if (storedContent) {
        console.log("Restoring saved task content");
        const taskContainer = document.getElementById('tasks-container');
        if (taskContainer) {
            taskContainer.innerHTML = storedContent;
            // Initialize any JS components in the restored content
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
        // Clear the stored content to prevent it from being used again
        sessionStorage.removeItem('todo_tasks_content');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    let socket;
    try {
        socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5
        });
    } catch (e) {
        console.error('Failed to initialize socket:', e);
        return;
    }

    socket.on('connect', () => {
        console.log('Connected to WebSocket server on Today page');
        socket.sendBuffer = [];  // Clear any buffered events
    });

    window.handleTaskAction = function(action, taskId) {
        console.log(`Handling ${action} for task ${taskId}`);
        const actionDiv = document.querySelector(`.task-actions[data-task-id="${taskId}"]`);
        if (!actionDiv) {
            console.error(`Task actions div not found for task ${taskId}`);
            return;
        }

        // Show loading state
        const originalContent = actionDiv.innerHTML;
        actionDiv.innerHTML = `
            <div class="d-inline-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" disabled>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading...
                </button>
            </div>
        `;

        // Set a timeout in case the server doesn't respond
        const timeout = setTimeout(() => {
            console.error('Server request timed out');
            actionDiv.innerHTML = originalContent;
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }, 10000);

        // Send socket event to the server
        socket.emit(action + '_task', { task_id: taskId }, function(response) {
            clearTimeout(timeout);
            
            if (!response) {
                console.error('No response from server');
                actionDiv.innerHTML = originalContent;
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                return;
            }
            
            if (response.status === 'success') {
                console.log('Task action successful:', response);
                
                if (action === 'start' && response.task && response.task.link) {
                    window.open(response.task.link, '_blank');
                }
                
                // Refresh page after task is completed or skipped
                if (action === 'finish' || action === 'skip') {
                    location.reload();
                } else if (action === 'start') {
                    // Update UI for started task
                    actionDiv.innerHTML = `
                        <div class="d-inline-flex gap-2">
                            <button onclick="handleTaskAction('finish', ${taskId})" class="btn btn-sm btn-success">
                                <i data-feather="check"></i> Finish
                            </button>
                            <button onclick="handleTaskAction('skip', ${taskId})" class="btn btn-sm btn-outline-secondary">
                                <i data-feather="skip-forward"></i> Skip
                            </button>
                        </div>
                    `;
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                }
            } else {
                console.error('Task action error:', response);
                actionDiv.innerHTML = originalContent;
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
                // Show error toast
                const errorToast = document.createElement('div');
                errorToast.className = 'position-fixed top-0 end-0 p-3';
                errorToast.style.zIndex = '5';
                errorToast.innerHTML = `
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-danger text-white">
                            <strong class="me-auto">Error</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close" 
                                   onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                        </div>
                        <div class="toast-body">
                            ${response.message || 'An error occurred while performing the action.'}
                        </div>
                    </div>
                `;
                document.body.appendChild(errorToast);
                
                // Remove toast after 4 seconds
                setTimeout(() => {
                    errorToast.remove();
                }, 4000);
            }
        });
    };

    // Function to reset today's tasks
    window.resetTodayTasks = function() {
        if (!confirm('Are you sure you want to reset your "Today" list? All tasks will return to inventory.')) {
            return;
        }
        
        fetch('/todo/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while resetting tasks.');
        });
    };
});
</script>

<div class="container">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1>To Do Today</h1>
            <button onclick="resetTodayTasks()" class="btn btn-outline-danger">
                <i data-feather="refresh-cw"></i> Reset List
            </button>
        </div>
        {% if tasks_by_curriculum %}

            {# Total and completed tasks are now displayed in a two-column layout #}
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3 mt-3">
                        <div class="card-body">
                            <h4>Today's Progress</h4>
                            <div class="progress mb-3" style="height: 30px;">
                                {% if total_tasks > 0 %}
                                <div class="progress-bar bg-primary" role="progressbar" 
                                     style="width: {{ (completed_tasks / total_tasks * 100) if total_tasks > 0 else 0 }}%" 
                                     aria-valuenow="{{ completed_tasks }}" aria-valuemin="0" aria-valuemax="{{ total_tasks }}">
                                    {{ completed_tasks }} / {{ total_tasks }} tasks
                                </div>
                                {% else %}
                                <div class="progress-bar bg-secondary" role="progressbar" style="width: 100%">
                                    No tasks
                                </div>
                                {% endif %}
                            </div>
                            <p class="card-text">
                                {% if total_tasks > 0 %}
                                You've completed <strong>{{ completed_tasks }}</strong> out of <strong>{{ total_tasks }}</strong> tasks.
                                {% else %}
                                You don't have any tasks for today.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3 mt-3">
                        <div class="card-body">
                            <h4>Time Spent Today</h4>
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="display-4 text-center">
                                    {{ hours_spent }}h {{ minutes_spent }}m
                                </div>
                            </div>
                            <p class="text-center mt-2">
                                {% if completed_tasks > 0 %}
                                Average: {{ avg_time_per_task|round(1) }} minutes per task
                                {% else %}
                                Complete some tasks to see your time stats
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tasks-container">
            {% for curriculum_id, tasks in tasks_by_curriculum.items() %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">{{ curriculum_names[curriculum_id] }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 50%">Task</th>
                                        <th style="width: 15%">Time Spent</th>
                                        <th style="width: 35%" class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student_task in tasks %}
                                    <tr>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <div class="d-flex align-items-center">
                                                    {% if student_task.task.action == 1 %}
                                                    <i data-feather="book-open" class="feather-sm me-2" title="Read"></i>
                                                    {% elif student_task.task.action == 2 %}
                                                    <i data-feather="video" class="feather-sm me-2" title="Watch"></i>
                                                    {% elif student_task.task.action == 3 %}
                                                    <i data-feather="headphones" class="feather-sm me-2" title="Listen"></i>
                                                    {% elif student_task.task.action == 4 %}
                                                    <i data-feather="edit-3" class="feather-sm me-2" title="Do"></i>
                                                    {% else %}
                                                    <i data-feather="circle" class="feather-sm me-2" title="Task"></i>
                                                    {% endif %}
                                                    <div>
                                                        {% if student_task.task.link %}
                                                        <a href="{{ student_task.task.link }}" target="_blank">{{ student_task.task.title }}</a>
                                                        {% else %}
                                                        {{ student_task.task.title }}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% if student_task.task.description %}
                                                <div class="ms-4 mt-1">
                                                    <small class="text-muted">{{ student_task.task.description }}</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if student_task.time_spent_minutes and student_task.time_spent_minutes > 0 %}
                                            {{ student_task.time_spent_minutes }} min
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <div class="task-actions" data-task-id="{{ student_task.task_id }}">
                                                {% if student_task.status == STATUS_NOT_STARTED %}
                                                <div class="d-inline-flex gap-2">
                                                    <button onclick="handleTaskAction('start', {{ student_task.task_id }})" class="btn btn-sm btn-outline-primary">
                                                        <i data-feather="play"></i> Start
                                                    </button>
                                                    <button onclick="handleTaskAction('skip', {{ student_task.task_id }})" class="btn btn-sm btn-outline-secondary">
                                                        <i data-feather="skip-forward"></i> Skip
                                                    </button>
                                                </div>
                                                {% elif student_task.status == STATUS_IN_PROGRESS %}
                                                <div class="d-inline-flex gap-2">
                                                    <button onclick="handleTaskAction('finish', {{ student_task.task_id }})" class="btn btn-sm btn-success">
                                                        <i data-feather="check"></i> Finish
                                                    </button>
                                                    <button onclick="handleTaskAction('skip', {{ student_task.task_id }})" class="btn btn-sm btn-outline-secondary">
                                                        <i data-feather="skip-forward"></i> Skip
                                                    </button>
                                                </div>
                                                {% elif student_task.status == STATUS_COMPLETED %}
                                                <div class="d-inline-flex gap-2">
                                                    <button class="btn btn-sm btn-success" disabled>
                                                        <i data-feather="check-circle"></i> Completed
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <h4 class="alert-heading">Welcome to your to do list for today!</h4>
                <p>You haven't promoted any tasks to your to do list yet. Visit your <a href="{{ url_for('inventory.index') }}" class="alert-link">Study Inventory</a> and promote the tasks you are certain you can accomplish today.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
