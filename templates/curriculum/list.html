{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Curriculums</h2>
    <a href="{{ url_for('curriculum.new') }}" class="btn btn-primary">
        <i data-feather="plus"></i> New Curriculum
    </a>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Search curriculums...">
    </div>
    <div class="col-md-4">
        <select id="gradeFilter" class="form-select">
            <option value="">All Grades</option>
            {% for grade_code, grade_name in [
                ('K', 'Kindergarten'),
                ('1', '1st Grade'),
                ('2', '2nd Grade'),
                ('3', '3rd Grade'),
                ('4', '4th Grade'),
                ('5', '5th Grade'),
                ('6', '6th Grade'),
                ('7', '7th Grade'),
                ('8', '8th Grade'),
                ('9', '9th Grade'),
                ('10', '10th Grade'),
                ('11', '11th Grade'),
                ('12', '12th Grade'),
                ('College', 'College')
            ] %}
                <option value="{{ grade_code }}">{{ grade_name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <select id="visibilityFilter" class="form-select">
            <option value="all">Public and Private</option>
            <option value="public">Public Only</option>
            <option value="private">Private Only</option>
        </select>
    </div>
</div>

<div class="row">
    {% for curriculum in curriculums %}
    <div class="col-md-4 mb-4" data-grades="{{ ','.join(curriculum.grade_levels) }}">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">{{ curriculum.name }}</h5>
                <p class="card-text">{{ curriculum.description }}</p>
                {% if curriculum.publisher %}
                <p class="card-text"><small class="text-muted">Publisher: {{ curriculum.publisher }}</small></p>
                {% endif %}
                {% if curriculum.grade_levels %}
                <p class="card-text"><small class="text-muted">Grade Level(s): {{ curriculum.grade_levels|join(', ') }}</small></p>
                {% endif %}
                <div class="mb-2">
                    {% if curriculum.published %}
                    <span class="badge bg-success">Public</span>
                    {% else %}
                    <span class="badge bg-secondary">Private</span>
                    {% endif %}
                    {% if curriculum.id in user_enrollments %}
                    <span class="badge bg-info">Enrolled</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex gap-2">
                    <a href="{{ url_for('curriculum.view', id=curriculum.id) }}" class="btn btn-sm btn-outline-primary">
                        <i data-feather="eye"></i> View
                    </a>
                    {% if curriculum.id not in user_enrollments %}
                    <a href="{{ url_for('curriculum.enroll', id=curriculum.id) }}" class="btn btn-sm btn-outline-success">
                        <i data-feather="user-plus"></i> Enroll
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const gradeFilter = document.getElementById('gradeFilter');
    const curriculumCards = document.querySelectorAll('.col-md-4');

    function filterCurriculums() {
        console.log('filterCurriculums called');
        const searchTerm = searchInput.value.toLowerCase();
        const selectedGrade = gradeFilter.value;
        console.log('Search term:', searchTerm);
        console.log('Selected grade:', selectedGrade);
        console.log('Selected visibility:', visibilityFilter.value);
        const selectedVisibility = visibilityFilter.value;

        curriculumCards.forEach(card => {
            // Extract card data
            const title = card.querySelector('.card-title').textContent.toLowerCase();
            const description = card.querySelector('.card-text').textContent.toLowerCase();
            const publisherElement = card.querySelector('.text-muted');
            const publisher = publisherElement ? publisherElement.textContent.toLowerCase() : '';
            const grades = card.getAttribute('data-grades') || '';
            const isPublic = card.querySelector('.badge.bg-success') !== null;

            // Check each filter condition
            const matchesSearch = !searchTerm || 
                title.includes(searchTerm) || 
                description.includes(searchTerm) || 
                publisher.includes(searchTerm);
                
            const matchesGrade = !selectedGrade || 
                grades.split(',').some(grade => grade.trim() === selectedGrade);
                
            const matchesVisibility = selectedVisibility === 'all' || 
                (selectedVisibility === 'public' && isPublic) || 
                (selectedVisibility === 'private' && !isPublic);

            // Show card only if ALL filters match
            card.style.display = (matchesSearch && matchesGrade && matchesVisibility) ? '' : 'none';
        });
    }

    const visibilityFilter = document.getElementById('visibilityFilter');
    
    searchInput.addEventListener('input', filterCurriculums);
    gradeFilter.addEventListener('change', filterCurriculums);
    visibilityFilter.addEventListener('change', filterCurriculums);
});
</script>
{% endblock %}
