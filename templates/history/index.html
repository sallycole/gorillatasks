{% extends "base.html" %}

{% block content %}
<style>
.time-display:hover {
    background-color: #f8f9fa;
    border: 1px dashed #dee2e6;
}
.time-edit {
    font-size: 0.875rem;
}
.loading-indicator {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}
.end-of-content {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    border-top: 1px solid #dee2e6;
    margin-top: 20px;
}
</style>
<div class="container">
    <h1 class="mb-4">Daily Activity History</h1>

    <div id="activity-container">
        <div class="mb-3">
            <p class="text-muted" id="activity-summary">
                Loading your activity history...
            </p>
        </div>

        <div class="accordion" id="historyAccordion">
            <!-- Days will be loaded here dynamically -->
        </div>

        <div id="loading-indicator" class="loading-indicator" style="display: none;">
            <i data-feather="loader" class="spinning"></i>
            Loading more days...
        </div>

        <div id="end-of-content" class="end-of-content" style="display: none;">
            <i data-feather="check-circle" class="text-success"></i>
            <p class="mb-0">You've reached the end of your activity history!</p>
        </div>

        <div id="no-activity" class="text-center py-5" style="display: none;">
            <i data-feather="calendar" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
            <h3 class="text-muted">No Activity Yet</h3>
            <p class="text-muted">Complete some tasks to see your daily activity history!</p>
            <a href="{{ url_for('todo.index') }}" class="btn btn-primary">Start Working on Tasks</a>
        </div>
    </div>
</div>

<style>
.spinning {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

<script>
let currentPage = 1;
let isLoading = false;
let hasMoreData = true;
let eventListenersAttached = false;
let totalDaysLoaded = 0;

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    loadInitialData();
    setupInfiniteScroll();
});

function initializePage() {
    feather.replace();

    // Only attach event listeners once to prevent duplicates
    if (!eventListenersAttached) {
        console.log('Attaching event listeners for time editing');
        // Use event delegation for time editing to work on all loaded content
        document.addEventListener('click', handleTimeDisplayClick);
        document.addEventListener('keydown', handleTimeInputKeydown);
        document.addEventListener('blur', handleTimeInputBlur, true);
        eventListenersAttached = true;
    }
}

function loadInitialData() {
    loadMoreDays();
}

function setupInfiniteScroll() {
    let throttleTimer;

    window.addEventListener('scroll', () => {
        if (throttleTimer) return;

        throttleTimer = setTimeout(() => {
            throttleTimer = null;

            const scrollHeight = document.documentElement.scrollHeight;
            const scrollTop = document.documentElement.scrollTop;
            const clientHeight = document.documentElement.clientHeight;

            // Load more when user is 500px from bottom
            if (scrollTop + clientHeight >= scrollHeight - 500) {
                if (!isLoading && hasMoreData) {
                    loadMoreDays();
                }
            }
        }, 100);
    });
}

function loadMoreDays() {
    if (isLoading || !hasMoreData) return;

    isLoading = true;
    showLoadingIndicator();

    fetch(`/history/api/days?page=${currentPage}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (data.days.length === 0) {
                // No more data
                hasMoreData = false;
                hideLoadingIndicator();

                if (totalDaysLoaded === 0) {
                    showNoActivity();
                } else {
                    showEndOfContent();
                }
                return;
            }

            appendDays(data.days);
            totalDaysLoaded += data.days.length;
            currentPage++;
            hasMoreData = data.has_more;

            updateActivitySummary();

            if (!hasMoreData) {
                showEndOfContent();
            }
        } else {
            console.error('Error loading days:', data.message);
            showError('Failed to load activity history. Please refresh the page.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Network error. Please check your connection and try again.');
    })
    .finally(() => {
        isLoading = false;
        hideLoadingIndicator();
    });
}

function appendDays(days) {
    const accordion = document.getElementById('historyAccordion');

    days.forEach((day, index) => {
        const dayElement = createDayElement(day, totalDaysLoaded + index + 1);
        accordion.appendChild(dayElement);
    });

    // Re-initialize feather icons for new content first
    feather.replace();
    
    // Initialize input fields in newly loaded content after a short delay
    // to ensure DOM is fully ready
    setTimeout(() => {
        initializeNewInputFields();
    }, 100);
}

function initializeNewInputFields() {
    console.log('Initializing new input fields...');
    
    // Find all time-edit inputs that haven't been initialized
    const newInputs = document.querySelectorAll('.time-edit:not([data-initialized])');
    console.log(`Found ${newInputs.length} new inputs to initialize`);
    
    newInputs.forEach(input => {
        const taskId = input.dataset.taskId;
        
        // Mark as initialized
        input.setAttribute('data-initialized', 'true');
        
        // Ensure input is properly hidden by default with minimal styling conflicts
        input.style.display = 'none';
        input.style.width = '100px'; // Increased width to accommodate larger numbers
        
        // Ensure the input is properly configured
        input.setAttribute('type', 'number');
        input.setAttribute('min', '0');
        input.setAttribute('max', '9999'); // Allow up to 4-digit numbers
        input.setAttribute('step', '1');
        input.classList.add('form-control', 'form-control-sm');
        
        console.log(`Initialized input for task ${taskId} - hidden by default`);
    });
    
    // Also ensure all time displays are properly configured
    const newTimeDisplays = document.querySelectorAll('.time-display:not([data-initialized])');
    console.log(`Found ${newTimeDisplays.length} new time displays to initialize`);
    
    newTimeDisplays.forEach(display => {
        const taskId = display.dataset.taskId;
        
        display.setAttribute('data-initialized', 'true');
        display.style.cursor = 'pointer';
        display.style.padding = '4px';
        display.style.borderRadius = '3px';
        display.style.minWidth = '60px'; // Ensure enough space for larger numbers
        display.setAttribute('title', 'Click to edit time spent');
        
        console.log(`Initialized time display for task ${taskId}`);
    });
    
    console.log('Input field initialization complete');
}

function createDayElement(day, index) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'accordion-item mb-3';

    dayDiv.innerHTML = `
        <h2 class="accordion-header" id="heading${index}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                    data-bs-target="#collapse${index}" aria-expanded="false" 
                    aria-controls="collapse${index}">
                <div class="w-100">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>${day.date_formatted}</strong>
                            <div class="text-muted small">${day.day_name}</div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-success">
                                <i data-feather="check-circle" class="feather-sm"></i>
                                ${day.completed_count} completed
                            </div>
                            ${day.skipped_count > 0 ? `
                            <div class="text-warning">
                                <i data-feather="skip-forward" class="feather-sm"></i>
                                ${day.skipped_count} skipped
                            </div>
                            ` : ''}
                        </div>
                        <div class="col-md-3">
                            <div class="text-info">
                                <i data-feather="clock" class="feather-sm"></i>
                                ${day.total_time_formatted}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-primary">${day.tasks.length} tasks</span>
                        </div>
                    </div>
                </div>
            </button>
        </h2>
        <div id="collapse${index}" class="accordion-collapse collapse" 
             aria-labelledby="heading${index}" data-bs-parent="#historyAccordion">
            <div class="accordion-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Status</th>
                                <th>Time Spent</th>
                                <th>Completed At</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${day.tasks.map(task => createTaskRow(task)).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    return dayDiv;
}

function createTaskRow(task) {
    const actionIcons = {
        1: '<i data-feather="book" class="text-primary feather-sm"></i>',
        2: '<i data-feather="video" class="text-success feather-sm"></i>',
        3: '<i data-feather="headphones" class="text-info feather-sm"></i>',
        4: '<i data-feather="edit-3" class="text-warning feather-sm"></i>'
    };

    const statusBadge = task.status === 2 
        ? '<span class="badge bg-success">Completed</span>'
        : '<span class="badge bg-warning">Skipped</span>';

    const taskLink = task.link 
        ? `<a href="${task.link}" target="_blank" class="ms-2 text-decoration-none">
               <i data-feather="external-link" class="feather-sm"></i>
           </a>`
        : '';

    const taskDescription = task.description 
        ? `<div class="text-muted small">${task.description}</div>`
        : '';

    // Ensure consistent time value handling
    const timeSpent = task.time_spent_minutes ? parseInt(task.time_spent_minutes) : 0;
    
    console.log(`Creating task row for task ID: ${task.id}, title: "${task.title}", timeSpent: ${timeSpent}`);
    
    return `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="task-icon me-2">
                        ${actionIcons[task.action] || '<i data-feather="clipboard" class="text-secondary feather-sm"></i>'}
                    </div>
                    <div>
                        <strong>${task.title}</strong>
                        ${taskLink}
                        ${taskDescription}
                    </div>
                </div>
            </td>
            <td>${statusBadge}</td>
            <td>
                <span class="time-display" 
                      data-task-id="${task.id}" 
                      data-current-time="${timeSpent}"
                      style="cursor: pointer; padding: 4px; border-radius: 3px;"
                      title="Click to edit time spent">
                    ${timeSpent} min
                </span>
                <input type="number" 
                       class="form-control form-control-sm time-edit" 
                       data-task-id="${task.id}"
                       value="${timeSpent}" 
                       min="0" 
                       max="9999"
                       step="1"
                       style="display: none; width: 100px;"
                       placeholder="Minutes">
            </td>
            <td>${task.completed_at || '--'}</td>
        </tr>
    `;
}

function updateActivitySummary() {
    const summaryElement = document.getElementById('activity-summary');
    summaryElement.textContent = `Showing ${totalDaysLoaded} active days`;
}

function showLoadingIndicator() {
    document.getElementById('loading-indicator').style.display = 'block';
}

function hideLoadingIndicator() {
    document.getElementById('loading-indicator').style.display = 'none';
}

function showEndOfContent() {
    document.getElementById('end-of-content').style.display = 'block';
}

function showNoActivity() {
    document.getElementById('no-activity').style.display = 'block';
    document.getElementById('activity-summary').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger';
    errorDiv.textContent = message;
    document.getElementById('activity-container').insertBefore(errorDiv, document.getElementById('historyAccordion'));

    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

// Time editing functions remain the same
function handleTimeDisplayClick(e) {
    if (e.target.classList.contains('time-display')) {
        const timeDisplay = e.target;
        const taskId = timeDisplay.dataset.taskId;
        const currentTime = timeDisplay.dataset.currentTime;
        let input = document.querySelector(`.time-edit[data-task-id="${taskId}"]`);

        console.log(`Clicked time display for task ${taskId}, current time: ${currentTime}`);
        console.log(`Time display element:`, timeDisplay);

        // If input doesn't exist, try to find it in the same row
        if (!input) {
            const row = timeDisplay.closest('tr');
            if (row) {
                input = row.querySelector('.time-edit');
                if (input) {
                    console.log(`Found input via row traversal for task ${taskId}`, input);
                    // Ensure the input has the correct task ID
                    input.dataset.taskId = taskId;
                } else {
                    console.error(`No input found in row for task ${taskId}`);
                    console.log(`Row HTML:`, row.innerHTML);
                }
            } else {
                console.error(`No row found for task ${taskId}`);
            }
        }

        if (input) {
            console.log(`Switching to edit mode for task ${taskId}`, input);

            // Ensure input is properly initialized if it wasn't before
            if (!input.hasAttribute('data-initialized')) {
                input.setAttribute('data-initialized', 'true');
                input.setAttribute('type', 'number');
                input.setAttribute('min', '0');
                input.setAttribute('max', '9999');
                input.setAttribute('step', '1');
                input.classList.add('form-control', 'form-control-sm');
                console.log(`Late initialization of input for task ${taskId}`);
            }

            // Reset time display styling but keep it visible initially
            timeDisplay.style.backgroundColor = '';
            timeDisplay.style.color = '';
            
            // Set input value and ensure it's properly configured
            input.value = currentTime;
            input.setAttribute('data-original-value', currentTime);
            input.dataset.taskId = taskId; // Ensure task ID is set

            // Show and configure input with minimal styling first
            input.style.display = 'inline-block';
            input.style.width = '100px';
            input.style.border = '1px solid #007bff';
            input.style.boxShadow = '0 0 0 0.2rem rgba(0, 123, 255, 0.25)';
            input.style.fontSize = '0.875rem';

            // Force reflow to ensure styles are applied
            input.offsetHeight;
            
            // Now hide time display after input is shown
            timeDisplay.style.display = 'none';
            
            // Force focus after a short delay to ensure visibility
            setTimeout(() => {
                try {
                    input.focus();
                    input.select();
                    console.log(`Input focused and selected for task ${taskId}`);
                } catch (error) {
                    console.error(`Error focusing input for task ${taskId}:`, error);
                    
                    // If focusing failed, restore the time display
                    timeDisplay.style.display = 'inline';
                    input.style.display = 'none';
                    input.style.boxShadow = '';
                    input.style.border = '1px solid #ced4da';
                }
            }, 100);
        } else {
            console.error(`Input not found for task ${taskId} even after row traversal`);
            console.log('Time display attributes:', timeDisplay.attributes);
            console.log('Available inputs:', document.querySelectorAll('.time-edit'));
            console.log('All time displays:', document.querySelectorAll('.time-display'));
            
            // Try to find the task by checking all time displays and their IDs
            const allTimeDisplays = document.querySelectorAll('.time-display');
            allTimeDisplays.forEach((display, index) => {
                console.log(`Time display ${index}: taskId=${display.dataset.taskId}, text="${display.textContent.trim()}"`);
            });
        }
    }
}

function handleTimeInputKeydown(e) {
    if (e.target.classList.contains('time-edit')) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveTimeChange(e.target);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelTimeEdit(e.target);
        }
    }
}

function handleTimeInputBlur(e) {
    if (e.target.classList.contains('time-edit')) {
        saveTimeChange(e.target);
    }
}

function saveTimeChange(input) {
    const taskId = input.dataset.taskId;
    const newTime = parseInt(input.value);
    const timeDisplay = document.querySelector(`.time-display[data-task-id="${taskId}"]`);
    const originalTime = parseInt(timeDisplay.dataset.currentTime) || 0;

    console.log(`Saving time change for task ${taskId}: ${originalTime} -> ${newTime}`);

    if (isNaN(newTime) || newTime < 0) {
        alert('Please enter a valid number of minutes');
        input.focus();
        return;
    }

    // Disable input during save
    input.disabled = true;
    input.style.opacity = '0.6';

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch(`/history/task/${taskId}/update_time`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            time_spent_minutes: newTime
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Server response:', data);
        if (data.status === 'success') {
            timeDisplay.textContent = `${data.new_time} min`;
            timeDisplay.dataset.currentTime = data.new_time;

            updateDailyTotal(taskId, originalTime, data.new_time);

            timeDisplay.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                timeDisplay.style.backgroundColor = '';
            }, 1000);

            console.log(`Time successfully updated to ${data.new_time} minutes`);
        } else {
            alert('Error updating time. Please try again.');
            console.error('Server error:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating time. Please try again.');
    })
    .finally(() => {
        // Reset input state
        input.disabled = false;
        input.style.opacity = '1';
        input.style.display = 'none';
        input.style.boxShadow = '';
        input.style.border = '1px solid #ced4da';
        
        // Ensure time display is properly shown
        timeDisplay.style.display = 'inline';
        timeDisplay.style.opacity = '1';
        
        console.log(`UI reset: input hidden, time display shown for task ${taskId}`);
    });
}

function cancelTimeEdit(input) {
    const taskId = input.dataset.taskId;
    const timeDisplay = document.querySelector(`.time-display[data-task-id="${taskId}"]`);

    if (timeDisplay) {
        input.value = timeDisplay.dataset.currentTime;
        timeDisplay.style.backgroundColor = '';
        timeDisplay.style.color = '';
        
        // Reset input
        input.style.display = 'none';
        input.style.boxShadow = '';
        input.style.border = '1px solid #ced4da';
        
        // Ensure time display is properly shown
        timeDisplay.style.display = 'inline';
        timeDisplay.style.opacity = '1';
        
        console.log(`Edit cancelled: time display restored for task ${taskId}`);
    } else {
        console.error(`Could not find time display for task ${taskId} to cancel edit`);
    }
}

function updateDailyTotal(taskId, oldTime, newTime) {
    const taskRow = document.querySelector(`tr:has(.time-display[data-task-id="${taskId}"])`);
    if (!taskRow) {
        console.log(`Task row not found for task ${taskId}`);
        return;
    }

    const accordionItem = taskRow.closest('.accordion-item');
    if (!accordionItem) {
        console.log(`Accordion item not found for task ${taskId}`);
        return;
    }

    const totalTimeElement = accordionItem.querySelector('.accordion-button .text-info');
    if (!totalTimeElement) {
        console.log(`Total time element not found for task ${taskId}`);
        return;
    }

    const currentTotalText = totalTimeElement.textContent.trim();
    let currentTotal = 0;

    const hourMatch = currentTotalText.match(/(\d+)h/);
    const minuteMatch = currentTotalText.match(/(\d+)m/);

    if (hourMatch) {
        currentTotal += parseInt(hourMatch[1]) * 60;
    }
    if (minuteMatch) {
        currentTotal += parseInt(minuteMatch[1]);
    }

    const difference = (newTime || 0) - (oldTime || 0);
    const newTotal = Math.max(0, currentTotal + difference);

    console.log(`Updating daily total: ${currentTotal} + (${newTime} - ${oldTime}) = ${newTotal}`);

    if (newTotal >= 60) {
        const hours = Math.floor(newTotal / 60);
        const minutes = newTotal % 60;
        totalTimeElement.innerHTML = `<i data-feather="clock" class="feather-sm"></i> ${hours}h ${minutes}m`;
    } else {
        totalTimeElement.innerHTML = `<i data-feather="clock" class="feather-sm"></i> ${newTotal}m`;
    }

    feather.replace();
}
</script>
{% endblock %}