<!DOCTYPE html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// When page loads, check for stored task content
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're returning from a redirect with stored content
    const storedContent = sessionStorage.getItem('today_tasks_content');
    if (storedContent) {
        console.log("Restoring saved task content");
        const taskContainer = document.getElementById('tasks-container');
        if (taskContainer) {
            taskContainer.innerHTML = storedContent;
            // Initialize any JS components in the restored content
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
        // Clear the stored content to prevent it from being used again
        sessionStorage.removeItem('today_tasks_content');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    let socket;
    try {
        socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5
        });
    } catch (e) {
        console.error('Failed to initialize socket:', e);
        return;
    }

    socket.on('connect', () => {
        console.log('Connected to WebSocket server on Today page');
        socket.sendBuffer = [];  // Clear any buffered events
    });

    window.handleTaskAction = function(action, taskId) {
        console.log(`Handling ${action} for task ${taskId} on Today page`);
        const actionDiv = document.querySelector(`.task-actions[data-task-id="${taskId}"]`);
        if (!actionDiv) {
            console.error('Could not find action div for task:', taskId);
            return;
        }

        // Store the current task list HTML before we modify it
        const taskContainer = document.getElementById('tasks-container');
        if (taskContainer) {
            // Only store content if we have tasks (prevents storing empty state)
            if (document.querySelectorAll('.task-row').length > 0) {
                sessionStorage.setItem('today_tasks_content', taskContainer.innerHTML);
            }
        }

        // Show loading state
        const originalContent = actionDiv.innerHTML;
        actionDiv.innerHTML = `
            <div class="d-inline-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" disabled>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading...
                </button>
            </div>
        `;

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // For start, finish, and skip actions, use fetch API to call the server
        fetch(`/today/task/${taskId}/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        // Try to parse error as JSON
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.message || `Server error: ${response.status}`);
                    } catch (e) {
                        // If not JSON, return the error text or status
                        throw new Error(`Server error: ${response.status} - ${text.substring(0, 100)}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            console.log(`Task ${action} response:`, data);

            if (data && data.status === 'success') {
                // Update UI based on action
                if (action === 'start') {
                    // Change to finish button
                    actionDiv.innerHTML = `
                        <div class="d-inline-flex gap-2">
                            <button onclick="handleTaskAction('finish', ${taskId})" class="btn btn-sm btn-success">
                                <i data-feather="check"></i> Finish
                            </button>
                            <button onclick="handleTaskAction('skip', ${taskId})" class="btn btn-sm btn-outline-secondary">
                                <i data-feather="skip-forward"></i> Skip
                            </button>
                        </div>
                    `;
                    // Open task link in new tab if available
                    if (data.task && data.task.link) {
                        window.open(data.task.link, '_blank');
                    }
                } else if (action === 'finish' || action === 'skip') {
                    // Add completed/skipped indicator
                    actionDiv.innerHTML = `
                        <div class="d-inline-flex gap-2">
                            <button class="btn btn-sm ${action === 'finish' ? 'btn-success' : 'btn-secondary'}" disabled>
                                <i data-feather="${action === 'finish' ? 'check-circle' : 'skip-forward'}"></i> 
                                ${action === 'finish' ? 'Completed' : 'Skipped'}
                            </button>
                        </div>
                    `;

                    // Update the task row appearance without removing it
                    const taskRow = actionDiv.closest('tr');
                    if (taskRow) {
                        // Add a completed class to visually indicate completion
                        taskRow.classList.add('completed-task');

                        // Update the time spent in the time-spent column if returned
                        if (data.time_spent) {
                            const hours = Math.floor(data.time_spent / 60);
                            const minutes = data.time_spent % 60;
                            const timeSpentCell = document.querySelector(`.time-spent[data-task-id="${taskId}"]`);
                            if (timeSpentCell) {
                                timeSpentCell.innerHTML = `${hours > 0 ? hours + 'h ' : ''}${minutes}m`;
                            }
                        }


                        // Reinitialize feather icons to show the checkmark properly
                        if (typeof feather !== 'undefined') {
                            feather.replace();
                        }

                        // Update task count in the UI and total time spent
                        updateTaskCount();
                        updateTimeSpent();
                    }

                    // We'll keep everything on the same page without clearing
                    function updateTaskCount() {
                        // Get the current counts
                        const totalTasks = document.querySelectorAll('.task-row').length;
                        const completedTasks = document.querySelectorAll('.task-row.completed-task').length;

                        // Update the goal display if it exists
                        const goalDisplay = document.querySelector('.card-body span');
                        if (goalDisplay) {
                            let totalTimeSpentMinutes = 0;
                            document.querySelectorAll('.task-row.completed-task').forEach(row => {
                                const timeSpent = row.querySelector('.time-spent');
                                if (timeSpent) {
                                    const timeParts = timeSpent.textContent.match(/(\d+)h? (\d+)m/);
                                    if (timeParts) {
                                        totalTimeSpentMinutes += parseInt(timeParts[1]) * 60 + parseInt(timeParts[2]);
                                    }
                                }
                            });

                            const totalTimeSpentHours = Math.floor(totalTimeSpentMinutes / 60);
                            const totalTimeSpentMinutesRemainder = totalTimeSpentMinutes % 60;
                            const averageTimePerTask = completedTasks > 0 ? Math.round(totalTimeSpentMinutes / completedTasks) : 0;

                            // Format the time spent string
                            let timeSpentString = '';
                            if (totalTimeSpentHours > 0) {
                                timeSpentString += totalTimeSpentHours + ' hours';
                                if (totalTimeSpentMinutesRemainder > 0) {
                                    timeSpentString += ' and ';
                                }
                            }
                            if (totalTimeSpentMinutesRemainder > 0 || totalTimeSpentHours === 0) {
                                timeSpentString += totalTimeSpentMinutesRemainder + ' minutes';
                            }

                            // Find the time spent element and update it
                            // Use standard JS selectors instead of jQuery-style :contains
                            const timeSpentHeadings = document.querySelectorAll('.card-body h4');
                            let timeSpentElement = null;

                            // Find the right heading and get its parent card body
                            for (const heading of timeSpentHeadings) {
                                if (heading.textContent === "Today's Time Spent") {
                                    timeSpentElement = heading.closest('.card-body').querySelector('span');
                                    break;
                                }
                            }

                            if (timeSpentElement) {
                                if (totalTimeSpentMinutes === 0) {
                                    timeSpentElement.textContent = 'No time recorded';
                                    timeSpentElement.className = 'progress-none';
                                } else {
                                    timeSpentElement.textContent = timeSpentString;
                                    timeSpentElement.className = completedTasks === totalTasks ? 'progress-complete' : 'progress-partial';
                                }
                            }


                            goalDisplay.textContent = `${completedTasks} / ${totalTasks} tasks done`;

                            // Update the class based on completion status
                            goalDisplay.className = completedTasks === 0 ? 'progress-none' : 
                                                  completedTasks < totalTasks ? 'progress-partial' : 
                                                  'progress-complete';
                        }
                    }


                }

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            } else {
                actionDiv.innerHTML = originalContent;
                alert(`Error: ${data.message || 'Unknown error'}`);
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        })
        .catch(error => {
            console.error('Task action error:', error);
            console.log(`Error response:`, error.response ? error.response : 'No response data');
            console.log(`Failed ${action} action for task ${taskId}`);
            actionDiv.innerHTML = originalContent;
        });
    };

    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    // Setup timer for in-progress tasks
    function updateInProgressTimers() {
        const inProgressElements = document.querySelectorAll('.in-progress-time');
        const now = new Date();

        inProgressElements.forEach(el => {
            const startedStr = el.getAttribute('data-started');
            if (startedStr) {
                const started = new Date(startedStr);
                const elapsedMinutes = Math.floor((now - started) / (1000 * 60));
                const hours = Math.floor(elapsedMinutes / 60);
                const minutes = elapsedMinutes % 60;

                if (hours > 0) {
                    el.textContent = `In progress (${hours}h ${minutes}m)`;
                } else {
                    el.textContent = `In progress (${minutes}m)`;
                }
            }
        });
    }

    // Initial update
    updateInProgressTimers();

    // Update every minute
    setInterval(updateInProgressTimers, 60000);
});
</script>

{% extends "base.html" %}

{% block content %}
<script>
function resetTodayTasks() {
    if (confirm('Are you sure you want to reset your To Do Today list? All tasks will be removed and returned to the Study Inventory page.')) {
        fetch('/today/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                const notification = document.createElement('div');
                notification.className = 'position-fixed top-0 end-0 p-3';
                notification.style.zIndex = '5';
                notification.innerHTML = `
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-success text-white">
                            <strong class="me-auto">Success</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close" 
                                  onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                        </div>
                        <div class="toast-body">
                            ${data.message}
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);

                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.remove();
                    location.reload(); // Refresh the page to reflect changes
                }, 3000);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => console.error('Error resetting tasks:', err));
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Check if we have stored task content from a previous action
    const taskContainer = document.querySelector('#tasks-container');
    const storedContent = sessionStorage.getItem('today_tasks_content');

    // If there's stored content and the current page shows "no tasks", restore the stored content
    if (storedContent && taskContainer && taskContainer.querySelector('.alert-info')) {
        taskContainer.innerHTML = storedContent;
        // Clear the storage after using it
        setTimeout(() => {
            sessionStorage.removeItem('today_tasks_content');
        }, 500);
    }

    // No automatic reset needed with the manual button
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// Function to calculate and update total time spent
function updateTimeSpent() {
    // Get all time spent cells
    const timeSpentCells = document.querySelectorAll('.time-spent');
    let totalMinutes = 0;

    // Sum up all time spent values from completed tasks
    timeSpentCells.forEach(cell => {
        // Only process cells that have time data (completed tasks)
        const text = cell.textContent.trim();
        if (text && !text.includes('In progress') && !text.includes('-')) {
            // Parse hours and minutes from the text
            let minutes = 0;
            if (text.includes('hours')) {
                const hoursMatch = text.match(/(\d+)\s+hours/);
                if (hoursMatch) {
                    minutes += parseInt(hoursMatch[1]) * 60;
                }
            }

            if (text.includes('minutes')) {
                const minutesMatch = text.match(/(\d+)\s+minutes/);
                if (minutesMatch) {
                    minutes += parseInt(minutesMatch[1]);
                }
            }

            totalMinutes += minutes;
        }
    });

    // Format the time spent string
    const hours = Math.floor(totalMinutes / 60);
    const remainingMinutes = totalMinutes % 60;
    let timeSpentString = '';

    if (hours > 0) {
        timeSpentString += hours + ' hours';
        if (remainingMinutes > 0) {
            timeSpentString += ' and ';
        }
    }

    if (remainingMinutes > 0 || hours === 0) {
        timeSpentString += remainingMinutes + ' minutes';
    }

    // Find and update the time spent display
    const timeSpentHeadings = document.querySelectorAll('.card-body h4');
    let timeSpentElement = null;

    for (const heading of timeSpentHeadings) {
        if (heading.textContent === "Today's Time Spent") {
            timeSpentElement = heading.closest('.card-body').querySelector('span');
            break;
        }
    }

    if (timeSpentElement) {
        if (totalMinutes === 0) {
            timeSpentElement.textContent = 'No time recorded';
            timeSpentElement.className = 'progress-none';
        } else {
            timeSpentElement.textContent = timeSpentString;
            timeSpentElement.className = 'progress-partial';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    let socket;
    try {
        socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5
        });
    } catch (e) {
        console.error('Failed to initialize socket:', e);
        return;
    }

    socket.on('connect', () => {
        console.log('Connected to WebSocket server');
        socket.sendBuffer = [];  // Clear any buffered events
        document.querySelectorAll('.task-actions').forEach(div => {
            div.classList.remove('disconnected');
        });
    });

    window.handleTaskAction = function(action, taskId) {
        if (!socket || !socket.connected) {
            console.error('Socket not connected');
            return;
        }

        console.log(`Handling ${action} for task ${taskId}`);
        const actionDiv = document.querySelector(`.task-actions[data-task-id="${taskId}"]`);
        if (!actionDiv) {
            console.error('Could not find action div for task:', taskId);
            return;
        }

        // Store the current task list HTML before we modify it
        const taskContainer = document.getElementById('tasks-container');
        if (taskContainer) {
            // Only store content if we have tasks (prevents storing empty state)
            if (document.querySelectorAll('.task-row').length > 0) {
                sessionStorage.setItem('today_tasks_content', taskContainer.innerHTML);
            }
        }


        // Show loading state
        const originalContent = actionDiv.innerHTML;
        actionDiv.innerHTML = `
            <div class="d-inline-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" disabled>
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading...
                </button>
            </div>
        `;

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Use direct fetch API instead of socket for simplicity
        fetch(`/today/task/${taskId}/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            // Check if response is ok before trying to parse JSON
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        // Try to parse error as JSON
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.message || `Server error: ${response.status}`);
                    } catch (e) {
                        // If not JSON, return the error text or status
                        throw new Error(`Server error: ${response.status} - ${text.substring(0,100)}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            if (data && data.status === 'success') {
                if (action === 'start') {
                    actionDiv.innerHTML = `
                        <div class="d-inline-flex gap-2">
                            <button onclick="handleTaskAction('finish', ${taskId})" class="btn btn-sm btn-success">
                                <i data-feather="check"></i> Finish
                            </button>
                            <button onclick="handleTaskAction('skip', ${taskId})" class="btn btn-sm btn-outline-secondary">
                                <i data-feather="skip-forward"></i> Skip
                            </button>
                        </div>
                    `;
                    if (data.task && data.task.link) {
                        window.open(data.task.link, '_blank');
                    }
                } else if (action === 'finish') {
                    // Change to completed button
                    actionDiv.innerHTML = `
                        <div class="d-inline-flex gap-2">
                            <button class="btn btn-sm btn-success" disabled>
                                <i data-feather="check-circle"></i> Completed
                            </button>
                        </div>
                    `;

                    // Update the time spent in the time-spent column if returned
                    if (data.time_spent) {
                        const hours = Math.floor(data.time_spent / 60);
                        const minutes = data.time_spent % 60;
                        const timeSpentCell = document.querySelector(`.time-spent[data-task-id="${taskId}"]`);
                        if (timeSpentCell) {
                            timeSpentCell.innerHTML = `${hours > 0 ? hours + 'h ' : ''}${minutes}m`;
                        }
                    }

                    // Update the task row appearance without removing it
                    const taskRow = actionDiv.closest('tr');
                    if (taskRow) {
                        // Add a completed class to visually indicate completion
                        taskRow.classList.add('completed-task');

                        // Reinitialize feather icons to show the checkmark properly
                        if (typeof feather !== 'undefined') {
                            feather.replace();
                        }

                        // Update task count in the UI
                        updateTaskCount();
                        updateTimeSpent(); // Call updateTimeSpent after updating individual task
                    }

                    // We'll keep everything on the same page without clearing

                } else if (action === 'skip') {
                    // Change to skipped button
                    actionDiv.innerHTML = `
                        <div class="d-inline-flex gap-2">
                            <button class="btn btn-sm btn-secondary" disabled>
                                <i data-feather="skip-forward"></i> Skipped
                            </button>
                        </div>
                    `;
                    const taskRow = actionDiv.closest('tr');
                    if (taskRow) {
                        taskRow.remove();
                        // Enhanced state management during task completion
                        const taskContainer = document.querySelector('#tasks-container');
                        if (taskContainer) {
                            // Always store current content in session storage before any action
                            // This ensures we have the latest state with remaining tasks
                            if (document.querySelectorAll('.task-row').length > 0) {
                                const currentContent = taskContainer.innerHTML;
                                sessionStorage.setItem('today_tasks_content', currentContent);
                                console.log("Stored task state before action");
                            }

                            // Don't replace the content, just update the current task
                            // This prevents the empty view issue
                            if (sessionStorage.getItem('today_tasks_content')) {
                                console.log("Restoring saved task state");
                                // We'll update just this task row instead of replacing everything
                            } else {
                                console.log("No saved state available");
                            }
                        }

                        // Delay reload slightly to allow server to process changes
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000); // Increased to 2000ms for better visibility
                    }

                    // Check if there are any tasks left
                    if (document.querySelectorAll('.task-row').length === 0) {
                        // Show the empty state
                        document.getElementById('tasks-container').innerHTML = `
                            <div class="alert alert-info">
                                <h4 class="alert-heading">Welcome to your to do list for today!</h4>
                                <p>You haven't promoted any tasks to your to do list yet. Visit your <a href="{{ url_for('inventory.index') }}" class="alert-link">Study Inventory</a> and promote the tasks you are certain you can accomplish today.</p>
                            </div>
                        `;
                    }
                    updateTimeSpent(); // Update time spent after skip
                }

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            } else {
                actionDiv.innerHTML = originalContent;
                alert(`Error: ${data.message || 'Unknown error'}`);
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        })
        .catch(error => {
            console.error('Task action error:', error);
            // Log detailed error information for debugging
            console.error('Error:', error);

            // Restore the original action buttons
            actionDiv.innerHTML = originalContent;

            // Show user-friendly error message
            alert(`Error: ${error.message || 'An unknown error occurred'}`);

            // Refresh Feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });
    };

    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    // Setup timer for in-progress tasks
    function updateInProgressTimers() {
        const inProgressElements = document.querySelectorAll('.in-progress-time');
        const now = new Date();

        inProgressElements.forEach(el => {
            const startedStr = el.getAttribute('data-started');
            if (startedStr) {
                const started = new Date(startedStr);
                const elapsedMinutes = Math.floor((now - started) / (1000 * 60));
                const hours = Math.floor(elapsedMinutes / 60);
                const minutes = elapsedMinutes % 60;

                if (hours > 0) {
                    el.textContent = `In progress (${hours}h ${minutes}m)`;
                } else {
                    el.textContent = `In progress (${minutes}m)`;
                }
            }
        });
    }

    // Initial update
    updateInProgressTimers();
    updateTimeSpent(); // Initial call to update time spent on page load

    // Update every minute
    setInterval(updateInProgressTimers, 60000);
});
</script>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1>To Do Today</h1>
            <button onclick="resetTodayTasks()" class="btn btn-outline-danger">
                <i data-feather="refresh-cw"></i> Reset List
            </button>
        </div>
        {% if tasks_by_curriculum %}

            {# Total and completed tasks are now displayed in a two-column layout #}
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3 mt-3">
                        <div class="card-body text-center">
                            <h4>Today's Goal</h4>
                            {% if completed_tasks == 0 and total_tasks == 0 %}
                                <span class="progress-none">{{ completed_tasks }} / {{ total_tasks }} tasks</span>
                            {% elif completed_tasks == 0 %}
                                <span class="progress-none">{{ completed_tasks }} / {{ total_tasks }} tasks</span>
                            {% elif completed_tasks < total_tasks %}
                                <span class="progress-partial">{{ completed_tasks }} / {{ total_tasks }} tasks</span>
                            {% else %}
                                <span class="progress-complete">{{ completed_tasks }} / {{ total_tasks }} tasks</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3 mt-3">
                        <div class="card-body text-center">
                            <h4>Today's Time Spent</h4>
                            <span class="progress-none">No time recorded</span>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<div id="tasks-container">
    {% if tasks_by_curriculum %}
        {% for curriculum_id, tasks in tasks_by_curriculum.items() %}
            <div class="card mb-4">
                <div class="card-header p-3">
                    <h3 class="mb-0">{{ curriculum_names[curriculum_id] }}</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 50%">Task</th>
                                    <th style="width: 20%">Time Spent</th>
                                    <th style="width: 30%" class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student_task in tasks %}
                                    <tr data-task-id="{{ student_task.task_id }}" class="task-row" {% if student_task.status == STATUS_COMPLETED %}class="bg-light"{% endif %}>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if student_task.task.action == 1 %}
                                                    <i data-feather="book-open" class="feather-sm me-2 text-purple" style="color: #6f42c1" title="Read"></i>
                                                {% elif student_task.task.action == 2 %}
                                                    <i data-feather="video" class="feather-sm me-2 text-purple" style="color: #6f42c1" title="Watch"></i>
                                                {% elif student_task.task.action == 3 %}
                                                    <i data-feather="headphones" class="feather-sm me-2 text-purple" style="color: #6f42c1" title="Listen"></i>
                                                {% elif student_task.task.action == 4 %}
                                                    <i data-feather="edit-3" class="feather-sm me-2 text-purple" style="color: #6f42c1" title="Do"></i>
                                                {% else %}
                                                    <i data-feather="circle" class="feather-sm me-2 text-purple" style="color: #6f42c1" title="Task"></i>
                                                {% endif %}
                                                <div>
                                                    <div>
                                                        {% if student_task.task.link %}
                                                            <a href="{{ student_task.task.link }}" target="_blank" {% if student_task.status == STATUS_COMPLETED %}style="text-decoration: line-through"{% endif %}>{{ student_task.task.title }}</a>
                                                        {% else %}
                                                            <span {% if student_task.status == STATUS_COMPLETED %}style="text-decoration: line-through"{% endif %}>{{ student_task.task.title }}</span>
                                                        {% endif %}
                                                    </div>
                                                    {% if student_task.task.description %}
                                                        <small class="text-muted">{{ student_task.task.description }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="time-spent" data-task-id="{{ student_task.task_id }}">
                                            {% if student_task.status == STATUS_COMPLETED and student_task.time_spent_minutes %}
                                                {% set hours = (student_task.time_spent_minutes // 60) %}
                                                {% set mins = (student_task.time_spent_minutes % 60) %}
                                                {% if hours > 0 %}{{ hours }} hours{% if mins > 0 %} and {% endif %}{% endif %}
                                                {% if mins > 0 or hours == 0 %}{{ mins }} minutes{% endif %}
                                            {% elif student_task.status == STATUS_COMPLETED %}
                                                0 minutes
                                            {% elif student_task.status == STATUS_IN_PROGRESS %}
                                                <span class="in-progress-time" data-started="{{ student_task.started_at }}">In progress</span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <div class="task-actions" data-task-id="{{ student_task.task_id }}">
                                                {% if student_task.status == STATUS_NOT_STARTED %}
                                                    <div class="d-inline-flex gap-2">
                                                        <button onclick="handleTaskAction('start', {{ student_task.task_id }})" class="btn btn-sm btn-outline-primary">
                                                            <i data-feather="play"></i> Start
                                                        </button>
                                                    </div>
                                                {% elif student_task.status == STATUS_IN_PROGRESS %}
                                                    <div class="d-inline-flex gap-2">
                                                        <button onclick="handleTaskAction('finish', {{ student_task.task_id }})" class="btn btn-sm btn-success">
                                                            <i data-feather="check"></i> Finish
                                                        </button>
                                                        <button onclick="handleTaskAction('skip', {{ student_task.task_id }})" class="btn btn-sm btn-outline-secondary">
                                                            <i data-feather="skip-forward"></i> Skip
                                                        </button>
                                                    </div>
                                                {% elif student_task.status == STATUS_COMPLETED %}
                                                    <div class="d-inline-flex gap-2">
                                                        <button class="btn btn-sm btn-success" disabled>
                                                            <i data-feather="check-circle"></i> Completed
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">        <h4 class="alert-heading">Welcome to your to do list for today!</h4>
            <p>You haven't promoted any tasks to your to do list yet. Visit your <a href="{{ url_for('inventory.index') }}" class="alert-link">Study Inventory</a> and promote the tasks you are certain you can accomplish today.</p>
        </div>
    {% endif %}
</div>
{% endblock %}